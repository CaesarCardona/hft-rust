<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Moving Average Live Plot</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #delay { font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>

<h2>Moving Average Live Plot (last 100 points)</h2>
<canvas id="maChart" width="800" height="400"></canvas>
<p id="delay">Live Delay: -- ms</p>

<script>
const ctx = document.getElementById('maChart').getContext('2d');
let chart;
let originNs = null;
const WINDOW_SIZE = 100;

async function loadData() {
  try {
    const res = await fetch('moving_avg.txt'); // must be served via HTTP
    if (!res.ok) throw new Error('Failed to fetch moving_avg.txt');
    const text = await res.text();
    const lines = text.split('\n').filter(l => l.trim());

    const data = lines.map(line => {
      const [ts, val] = line.split(',');
      if (!ts || !val) return null;
      return { timestamp: BigInt(ts.trim()), value: parseFloat(val.trim()) };
    }).filter(d => d && !isNaN(d.value));

    if (data.length === 0) return;

    if (!originNs) originNs = data[0].timestamp;

    // Take last WINDOW_SIZE points
    const windowData = data.slice(-WINDOW_SIZE);

    // X-axis: simple indices
    const labels = windowData.map((_, i) => i);
    const values = windowData.map(d => d.value);

    // Timestamps for tooltip
    const timestamps = windowData.map(d => d.timestamp);

    if (!chart) {
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Moving Average',
            data: values,
            borderColor: 'red',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const index = context.dataIndex;
                  const ts = timestamps[index];
                  return `Value: ${context.formattedValue}, Timestamp: ${ts}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Point Index (latest 100)' }
            },
            y: { title: { display: true, text: 'Moving Average' } }
          }
        }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update();
    }

    // Live delay (ms)
    const last = windowData[windowData.length - 1];
    const nowNs = BigInt(Date.now()) * 1_000_000n;
    const delayMs = Number(nowNs - last.timestamp) / 1_000_000;
    document.getElementById('delay').innerText = `Live Delay: ${delayMs.toFixed(2)} ms`;

  } catch (err) {
    console.error('Error loading moving_avg.txt:', err);
  }
}

// Refresh every 500ms
setInterval(loadData, 500);
loadData(); // initial load
</script>

</body>
</html>

